# 运势生成功能说明

## 功能概述

已完善 `generateFortune` 方法，实现了完整的运势生成流程：
1. 调用DeepSeek API生成运势文案
2. 根据文案生成运势图片
3. 上传图片到阿里云OSS
4. 返回图片访问URL

## 实现内容

### 1. DeepSeek配置类
- `DeepSeekProperties` - 读取DeepSeek配置信息（API Key和Base URL）

### 2. DeepSeek服务
- `DeepSeekService` - DeepSeek服务接口
- `DeepSeekServiceImpl` - DeepSeek服务实现
  - 调用DeepSeek API生成运势文案
  - 使用优化的提示词生成详细的运势报告

### 3. 运势图片生成服务
- `FortuneImageService` - 运势图片生成服务接口
- `FortuneImageServiceImpl` - 运势图片生成服务实现
  - 生成800x1200的运势图片
  - 包含姓名、出生日期、运势内容
  - 使用渐变背景和优雅的排版

### 4. 完善的方法
- `ToolServiceImpl.generateFortune()` - 完整的运势生成流程

## 配置说明

### DeepSeek配置（application-dev.yml）

```yaml
deepseek:
  api-key: sk-a2841844c7634729bf626397734a8fdd  # DeepSeek API Key
  base-url: https://api.deepseek.com/chat/completions  # DeepSeek API地址
```

### OSS配置

已在配置文件中配置OSS信息，确保可以正常上传图片。

## 功能流程

1. **接收请求**
   - 接收姓名（name）和出生日期（birthDate）

2. **检查限流**
   - 调用 `dailyLimitService.checkAndIncrement()` 检查每日限流

3. **生成运势文案**
   - 调用 `deepSeekService.generateFortuneText()` 生成运势文案
   - 使用优化的提示词，生成包含今日、本周、本月运势的详细报告
   - 包含事业、爱情、健康、财运四个方面

4. **生成运势图片**
   - 调用 `fortuneImageService.generateFortuneImage()` 生成图片
   - 图片尺寸：800x1200
   - 包含标题、出生日期、运势内容、底部装饰

5. **转换为字节数组**
   - 使用 `ImageIO.write()` 将BufferedImage转换为PNG格式的字节数组

6. **上传到OSS**
   - 生成文件路径：`fortune/yyyyMMdd/姓名_出生日期_时间戳.png`
   - 调用 `ossService.uploadFile()` 上传到OSS
   - 返回完整的访问URL

7. **保存记录**
   - 保存生成记录到数据库

## 运势文案内容

DeepSeek生成的运势文案包含：
- **今日运势**：当天的整体运势
- **本周运势**：本周的整体运势
- **本月运势**：本月的整体运势
- **事业运势**：工作、事业发展
- **爱情运势**：感情、人际关系
- **健康运势**：身体健康状况
- **财运运势**：财富、投资

每个方面用2-3句话描述，总字数控制在300字以内。

## 图片设计

- **尺寸**：800x1200像素
- **背景**：渐变背景（从浅黄到米色）
- **标题**：姓名 + "运势测试"（棕色、加粗、居中）
- **日期**：出生日期（灰色、居中）
- **内容**：运势文案（自动换行、左对齐）
- **装饰**：分割线和底部文字

## 文件路径规则

上传到OSS的文件路径格式：
```
fortune/yyyyMMdd/姓名_出生日期_时间戳.png
```

示例：
```
fortune/20231209/张三_19900101_1702098000000.png
fortune/20231209/李四_19951215_1702098001000.png
```

## 提示词优化

DeepSeek提示词包含以下要求：
1. 包含今日、本周、本月运势
2. 包含事业、爱情、健康、财运四个方面
3. 语言温馨、积极、有指导性
4. 每个方面2-3句话
5. 格式清晰，便于阅读
6. 总字数控制在300字以内

## 注意事项

1. **DeepSeek API**
   - 确保API Key有效
   - 注意API调用频率限制
   - 如果API调用失败，会抛出异常

2. **图片生成**
   - 使用中文字体，如果系统没有会回退到默认字体
   - 文本自动换行，适应图片宽度
   - 如果内容过长，会截断超出部分

3. **OSS上传**
   - 确保OSS配置正确
   - 确保有上传权限
   - 文件路径使用日期分类，便于管理

4. **错误处理**
   - DeepSeek API调用失败会抛出异常
   - 图片生成失败会抛出异常
   - OSS上传失败会抛出异常

## 测试

### 测试步骤

1. 确保DeepSeek API Key配置正确
2. 确保OSS配置正确
3. 启动后端服务
4. 调用接口：
   ```json
   POST /tool/fortune
   {
       "name": "张三",
       "birthDate": "1990-01-01"
   }
   ```
5. 检查返回的URL是否可以访问

### 验证

- ✅ DeepSeek API调用成功
- ✅ 运势文案生成成功
- ✅ 图片已生成
- ✅ 图片已上传到OSS
- ✅ 返回的URL可以正常访问
- ✅ 数据库已保存生成记录

## 后续优化建议

1. **文案优化**
   - 根据出生日期计算星座、生肖
   - 添加更多个性化内容
   - 支持不同风格的运势报告

2. **图片优化**
   - 支持自定义背景
   - 添加更多装饰元素
   - 支持不同尺寸

3. **性能优化**
   - 缓存常见运势文案
   - 异步生成和上传
   - 优化图片生成速度

4. **功能扩展**
   - 支持运势分享
   - 支持运势收藏
   - 支持历史运势查询

