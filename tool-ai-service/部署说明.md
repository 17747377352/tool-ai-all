# 部署说明

## 配置文件外部化

项目已配置为打包时不包含敏感配置文件，配置文件需要放在jar包同级目录下。

## 打包步骤

### 1. 执行打包命令

**开发环境（默认，包含配置文件）：**
```bash
mvn clean package
# 或
mvn clean package -Pdev
```

**打包部署（排除配置文件）：**
```bash
mvn clean package -Ppackage
```

打包完成后，jar包位于：`target/tool-ai-service-1.0.jar`

### 2. 打包内容说明

- ✅ **包含**：代码、依赖库、基础配置（application.yml）
- ❌ **不包含**：`application-dev.yml`、`application-prod.yml` 等环境配置文件

## 部署步骤

### 1. 准备部署目录

```bash
# 创建部署目录
mkdir -p /opt/tool-ai-service
cd /opt/tool-ai-service

# 复制jar包
cp target/tool-ai-service-1.0.jar /opt/tool-ai-service/
```

### 2. 准备配置文件

将配置文件放在jar包同级目录：

```bash
# 复制配置文件模板
cp src/main/resources/application-dev.yml.example /opt/tool-ai-service/application-dev.yml

# 编辑配置文件，填入实际配置
vi /opt/tool-ai-service/application-dev.yml
```

**目录结构：**
```
/opt/tool-ai-service/
├── tool-ai-service-1.0.jar          # jar包
├── application-dev.yml              # 配置文件（需要手动创建）
└── start.sh                         # 启动脚本（可选）
```

### 3. 配置文件内容

编辑 `application-dev.yml`，填入实际配置：

```yaml
spring:
  datasource:
    url: jdbc:mysql://your-db-host:3306/tool?serverTimezone=UTC&useUnicode=true&characterEncoding=utf-8
    username: your-username
    password: your-password
    driver-class-name: com.mysql.cj.jdbc.Driver
  redis:
    host: your-redis-host
    port: 6379
    password: your-redis-password

# 其他配置...
```

### 4. 启动应用

#### 方式一：使用启动脚本（推荐）

**Linux/Mac:**
```bash
# 复制启动脚本
cp start.sh /opt/tool-ai-service/
chmod +x /opt/tool-ai-service/start.sh

# 前台运行（默认使用 application-dev.yml）
./start.sh

# 指定配置文件
./start.sh application-prod.yml

# 后台运行
./start.sh application-prod.yml daemon
```

**Windows:**
```cmd
# 前台运行（默认使用 application-dev.yml）
start.bat

# 指定配置文件
start.bat application-prod.yml
```

#### 方式二：直接使用java命令

```bash
java -jar \
    -Dspring.config.location=file:./application-dev.yml \
    tool-ai-service-1.0.jar
```

#### 方式三：指定多个配置文件

```bash
java -jar \
    -Dspring.config.location=file:./application-dev.yml,file:./application-prod.yml \
    tool-ai-service-1.0.jar
```

## 配置文件优先级

Spring Boot 配置文件加载优先级（从高到低）：

1. **命令行参数**：`--spring.config.location=file:./application-dev.yml`
2. **外部配置文件**：jar包同级目录的 `application-dev.yml`
3. **jar包内配置**：`application.yml`（基础配置）

## 环境变量配置（可选）

也可以通过环境变量覆盖配置：

```bash
export SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/tool
export SPRING_DATASOURCE_USERNAME=root
export SPRING_DATASOURCE_PASSWORD=password

java -jar tool-ai-service-1.0.jar
```

## 生产环境建议

### 1. 使用 systemd 管理服务（Linux）

创建服务文件 `/etc/systemd/system/tool-ai-service.service`：

```ini
[Unit]
Description=Tool AI Service
After=network.target

[Service]
Type=simple
User=app
WorkingDirectory=/opt/tool-ai-service
# 使用外部配置文件启动
ExecStart=/usr/bin/java -jar -Dspring.config.location=file:/opt/tool-ai-service/application-prod.yml /opt/tool-ai-service/tool-ai-service-1.0.jar
# 或者使用启动脚本
# ExecStart=/opt/tool-ai-service/start.sh application-prod.yml daemon
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable tool-ai-service
sudo systemctl start tool-ai-service
```

### 2. 配置文件权限

确保配置文件权限安全：

```bash
chmod 600 application-dev.yml  # 仅所有者可读写
chown app:app application-dev.yml  # 设置正确的所有者
```

### 3. 日志目录

确保日志目录存在且有写权限：

```bash
mkdir -p logs
chmod 755 logs
```

## 常见问题

### Q: 启动时找不到配置文件？

A: 确保配置文件在jar包同级目录，且文件名正确（如 `application-dev.yml`）

### Q: 如何切换环境？

A: 修改启动命令中的配置文件路径，或使用 `--spring.profiles.active=prod` 参数

### Q: 配置文件中的敏感信息如何保护？

A: 
1. 使用环境变量
2. 使用配置中心（如 Nacos、Apollo）
3. 使用加密配置（如 Jasypt）

## 注意事项

1. ⚠️ **配置文件不要提交到代码仓库**
2. ⚠️ **生产环境配置文件要妥善保管**
3. ⚠️ **定期备份配置文件**
4. ✅ **使用版本控制管理配置文件模板（.example文件）**

