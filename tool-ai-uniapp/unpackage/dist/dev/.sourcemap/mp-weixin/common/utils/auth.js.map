{"version":3,"file":"auth.js","sources":["common/utils/auth.js"],"sourcesContent":["/**\n * 认证工具\n */\nimport apiConfig from '@/common/config/api-config.js';\n\n/**\n * 检查并获取用户授权\n */\nexport const checkUserAuth = () => {\n    return new Promise((resolve, reject) => {\n        // #ifdef MP-WEIXIN\n        uni.getSetting({\n            success: (res) => {\n                if (res.authSetting['scope.userInfo']) {\n                    // 已授权\n                    resolve(true);\n                } else {\n                    // 未授权，需要用户点击授权按钮\n                    reject(new Error('需要授权'));\n                }\n            },\n            fail: reject\n        });\n        // #endif\n\n        // #ifndef MP-WEIXIN\n        resolve(true);\n        // #endif\n    });\n};\n\n/**\n * 获取用户信息并解密\n */\nexport const getUserInfoAndDecrypt = () => {\n    return new Promise((resolve, reject) => {\n        // #ifdef MP-WEIXIN\n        uni.getUserProfile({\n            desc: '用于完善用户资料',\n            success: async (res) => {\n                try {\n                    // 获取session_key（需要从后端获取，这里简化处理）\n                    const code = await getWxCode();\n                    const loginRes = await uni.request({\n                        url: `${apiConfig.BASE_URL}/auth/wx-login`,\n                        method: 'POST',\n                        data: { code }\n                    });\n\n                    if (loginRes.data.code === 200) {\n                        const sessionKey = loginRes.data.data.sessionKey; // 注意：实际不应该返回sessionKey给前端\n                        // 调用解密接口\n                        const decryptRes = await uni.request({\n                            url: `${apiConfig.BASE_URL}/auth/decrypt-userinfo`,\n                            method: 'POST',\n                            header: {\n                                'Authorization': `Bearer ${uni.getStorageSync('token')}`\n                            },\n                            data: {\n                                encryptedData: res.encryptedData,\n                                iv: res.iv,\n                                sessionKey: sessionKey\n                            }\n                        });\n\n                        if (decryptRes.data.code === 200) {\n                            resolve(res.userInfo);\n                        } else {\n                            reject(new Error('解密失败'));\n                        }\n                    } else {\n                        reject(new Error('登录失败'));\n                    }\n                } catch (e) {\n                    reject(e);\n                }\n            },\n            fail: reject\n        });\n        // #endif\n\n        // #ifndef MP-WEIXIN\n        resolve({});\n        // #endif\n    });\n};\n\nconst getWxCode = () => {\n    return new Promise((resolve, reject) => {\n        uni.login({\n            provider: 'weixin',\n            success: (res) => {\n                resolve(res.code);\n            },\n            fail: reject\n        });\n    });\n};\n\n\n"],"names":["uni","apiConfig"],"mappings":";;;AAQY,MAAC,gBAAgB,MAAM;AAC/B,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AAEpCA,kBAAAA,MAAI,WAAW;AAAA,MACX,SAAS,CAAC,QAAQ;AACd,YAAI,IAAI,YAAY,gBAAgB,GAAG;AAEnC,kBAAQ,IAAI;AAAA,QAChC,OAAuB;AAEH,iBAAO,IAAI,MAAM,MAAM,CAAC;AAAA,QAC3B;AAAA,MACJ;AAAA,MACD,MAAM;AAAA,IAClB,CAAS;AAAA,EAMT,CAAK;AACL;AAKY,MAAC,wBAAwB,MAAM;AACvC,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AAEpCA,kBAAAA,MAAI,eAAe;AAAA,MACf,MAAM;AAAA,MACN,SAAS,OAAO,QAAQ;AACpB,YAAI;AAEA,gBAAM,OAAO,MAAM;AACnB,gBAAM,WAAW,MAAMA,cAAG,MAAC,QAAQ;AAAA,YAC/B,KAAK,GAAGC,kCAAU,QAAQ;AAAA,YAC1B,QAAQ;AAAA,YACR,MAAM,EAAE,KAAM;AAAA,UACtC,CAAqB;AAED,cAAI,SAAS,KAAK,SAAS,KAAK;AAC5B,kBAAM,aAAa,SAAS,KAAK,KAAK;AAEtC,kBAAM,aAAa,MAAMD,cAAG,MAAC,QAAQ;AAAA,cACjC,KAAK,GAAGC,kCAAU,QAAQ;AAAA,cAC1B,QAAQ;AAAA,cACR,QAAQ;AAAA,gBACJ,iBAAiB,UAAUD,cAAAA,MAAI,eAAe,OAAO,CAAC;AAAA,cACzD;AAAA,cACD,MAAM;AAAA,gBACF,eAAe,IAAI;AAAA,gBACnB,IAAI,IAAI;AAAA,gBACR;AAAA,cACH;AAAA,YAC7B,CAAyB;AAED,gBAAI,WAAW,KAAK,SAAS,KAAK;AAC9B,sBAAQ,IAAI,QAAQ;AAAA,YAChD,OAA+B;AACH,qBAAO,IAAI,MAAM,MAAM,CAAC;AAAA,YAC3B;AAAA,UACzB,OAA2B;AACH,mBAAO,IAAI,MAAM,MAAM,CAAC;AAAA,UAC3B;AAAA,QACJ,SAAQ,GAAG;AACR,iBAAO,CAAC;AAAA,QACX;AAAA,MACJ;AAAA,MACD,MAAM;AAAA,IAClB,CAAS;AAAA,EAMT,CAAK;AACL;AAEA,MAAM,YAAY,MAAM;AACpB,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACpCA,kBAAAA,MAAI,MAAM;AAAA,MACN,UAAU;AAAA,MACV,SAAS,CAAC,QAAQ;AACd,gBAAQ,IAAI,IAAI;AAAA,MACnB;AAAA,MACD,MAAM;AAAA,IAClB,CAAS;AAAA,EACT,CAAK;AACL;;;"}