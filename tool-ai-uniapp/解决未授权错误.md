# 解决 "未授权" 错误

## 错误信息

```
业务异常: 未授权
```

## 原因分析

这个错误通常出现在以下情况：

1. **请求未携带 Token**
   - 某些请求直接使用 `uni.request` 而不是封装的 `request.js`
   - Token 未正确保存或已过期

2. **Token 未正确传递**
   - Header 中未设置 `Authorization: Bearer {token}`
   - Token 格式不正确

3. **登录时机问题**
   - 在登录完成前就发起了需要认证的请求
   - 多个地方重复登录导致冲突

## 已修复的问题

### 1. 优化登录逻辑

- ✅ App.vue 中已添加 token 检查，避免重复登录
- ✅ index.vue 中移除了重复的登录逻辑
- ✅ 登录成功后正确保存 token

### 2. 统一使用 request.js

所有需要认证的请求都应该使用 `common/utils/request.js`，它会自动携带 token。

**正确用法：**
```javascript
import api from '@/common/utils/api.js'

// 使用封装的API
const res = await api.generateNameSign({ surname: '张' })
```

**错误用法：**
```javascript
// 直接使用uni.request，不会携带token
const res = await uni.request({
    url: 'http://localhost:8080/tool/name-sign',
    method: 'POST',
    data: { surname: '张' }
})
```

## 验证步骤

### 1. 检查 Token 是否保存

在微信开发者工具的控制台中执行：
```javascript
// 查看token
console.log(uni.getStorageSync('token'))
```

应该能看到一个 JWT token 字符串。

### 2. 检查请求 Header

在微信开发者工具的 Network 面板中：
1. 查看需要认证的请求
2. 检查 Request Headers 中是否有：
   ```
   Authorization: Bearer {token}
   ```

### 3. 检查登录流程

1. 打开小程序
2. 查看控制台，应该看到：
   - "登录成功，token已保存"
3. 如果已有 token，应该看到：
   - "已有token，跳过登录"

## 常见问题

### Q: 为什么有些请求还是报未授权？

A: 检查以下几点：
1. ✅ 是否使用了 `api.js` 中的方法（会自动携带token）
2. ✅ 是否直接使用了 `uni.request`（不会携带token）
3. ✅ Token 是否已正确保存

### Q: Token 过期了怎么办？

A: `request.js` 中已处理：
- 如果返回 401，会自动清除 token 并跳转到首页
- 用户需要重新登录

### Q: 如何手动刷新 Token？

A: 清除 token 后重新登录：
```javascript
uni.removeStorageSync('token')
uni.removeStorageSync('openid')
// 然后重新调用登录
```

## 调试技巧

### 1. 查看 Token

```javascript
// 在控制台执行
console.log('Token:', uni.getStorageSync('token'))
console.log('OpenID:', uni.getStorageSync('openid'))
```

### 2. 查看请求详情

在微信开发者工具的 Network 面板中：
- 查看请求的 Headers
- 查看响应的错误信息

### 3. 查看后端日志

后端日志会显示：
- 是否收到 token
- token 验证结果
- 具体的错误信息

## 代码检查清单

- [ ] 所有需要认证的请求都使用 `api.js` 中的方法
- [ ] 没有直接使用 `uni.request` 调用需要认证的接口
- [ ] App.vue 中的登录逻辑正常
- [ ] Token 已正确保存到本地存储
- [ ] 请求 Header 中包含 `Authorization: Bearer {token}`

## 如果问题仍然存在

1. **清除缓存重新登录**
   ```javascript
   uni.clearStorageSync()
   // 重新打开小程序
   ```

2. **检查后端日志**
   - 查看具体的错误信息
   - 确认 token 是否正确传递

3. **检查网络请求**
   - 在 Network 面板查看请求详情
   - 确认 Header 是否正确




