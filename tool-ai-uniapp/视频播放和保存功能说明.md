# 小程序视频播放和保存功能说明

## 功能概述

已修改 `result.vue` 页面，支持：
1. **自动识别视频/图片**：根据 URL 特征自动判断是视频还是图片
2. **视频播放**：使用 `<video>` 组件播放视频
3. **保存到本地**：支持保存图片和视频到相册

## 主要修改

### 1. 模板部分

- 添加了视频播放容器 `<video>` 组件
- 根据 `isVideo` 标志动态显示视频或图片
- 视频组件配置了完整的播放控制功能

### 2. 逻辑部分

- **`isVideoUrl()` 方法**：判断 URL 是否为视频
  - 检查文件扩展名（.mp4, .m3u8, .flv 等）
  - 检查 URL 关键词（video, play, stream 等）
  - 检查抖音/小红书视频链接特征

- **`downloadAndSaveVideo()` 方法**：下载并保存视频
  - 使用 `uni.downloadFile()` 下载视频
  - 使用 `uni.saveVideoToPhotosAlbum()` 保存到相册
  - 完善的错误处理和权限提示

- **`downloadAndSaveImage()` 方法**：下载并保存图片（已优化）
  - 添加了加载提示
  - 改进了错误处理

### 3. 样式部分

- 添加了视频容器样式
- 视频使用黑色背景，更好的观看体验

## 小程序配置要求

### 1. 域名白名单配置

在微信小程序后台配置以下域名：

1. **视频播放域名**：
   - 抖音视频域名（如：`*.douyin.com`, `*.iesdouyin.com`）
   - 小红书视频域名（如：`*.xiaohongshu.com`）
   - 其他视频 CDN 域名

2. **下载域名**：
   - 与播放域名相同

**配置步骤**：
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入「开发」→「开发管理」→「开发设置」
3. 在「服务器域名」中添加：
   - **request合法域名**：添加后端 API 域名
   - **downloadFile合法域名**：添加视频下载域名
   - **video合法域名**：添加视频播放域名

### 2. 权限配置

小程序需要以下权限：

1. **相册权限**：
   - iOS：需要在 `manifest.json` 中配置
   - Android：已在 `manifest.json` 中配置了存储权限

2. **网络权限**：
   - 已在 `manifest.json` 中配置

### 3. manifest.json 配置

已检查 `manifest.json`，Android 权限已配置完整。如果需要 iOS 权限，可以添加：

```json
{
  "app-plus": {
    "distribute": {
      "ios": {
        "privacyDescription": {
          "NSPhotoLibraryAddUsageDescription": "需要访问相册以保存视频和图片"
        }
      }
    }
  }
}
```

## 使用说明

### 视频播放

1. 当去水印返回视频链接时，页面会自动识别为视频
2. 使用 `<video>` 组件播放，支持：
   - 播放/暂停控制
   - 全屏播放
   - 进度条控制
   - 手势播放

### 保存到本地

1. 点击「保存视频到相册」或「保存到相册」按钮
2. 系统会先显示激励视频广告
3. 然后下载文件（显示加载提示）
4. 保存到相册
5. 显示保存成功提示

### 错误处理

- **网络错误**：显示友好的错误提示
- **权限错误**：提示用户开启相册权限
- **下载失败**：提示可能的原因（网络问题或链接失效）

## 测试建议

### 1. 测试视频播放

```javascript
// 测试不同类型的视频链接
const testUrls = [
  'https://example.com/video.mp4',           // MP4 格式
  'https://example.com/video.m3u8',          // HLS 格式
  'https://v.douyin.com/xxx/',               // 抖音链接
  'https://www.xiaohongshu.com/xxx'          // 小红书链接
];
```

### 2. 测试保存功能

1. 测试保存图片
2. 测试保存视频
3. 测试权限拒绝的情况
4. 测试网络错误的情况

### 3. 真机测试

- **iOS**：测试相册权限请求
- **Android**：测试存储权限
- **网络**：测试不同网络环境下的播放和下载

## 常见问题

### Q1: 视频无法播放

**可能原因**：
1. 域名未配置到白名单
2. 视频链接格式不支持
3. 网络问题

**解决方案**：
1. 检查小程序后台的域名白名单配置
2. 检查视频链接是否有效
3. 检查网络连接

### Q2: 保存失败

**可能原因**：
1. 未授权相册权限
2. 存储空间不足
3. 视频文件过大

**解决方案**：
1. 在系统设置中开启相册权限
2. 清理存储空间
3. 检查视频文件大小

### Q3: 视频播放卡顿

**可能原因**：
1. 网络速度慢
2. 视频文件过大
3. 设备性能问题

**解决方案**：
1. 检查网络连接
2. 考虑添加视频预加载
3. 优化视频格式或分辨率

## 后续优化建议

1. **视频预加载**：提前加载视频，提升播放体验
2. **进度显示**：显示下载进度条
3. **断点续传**：支持大文件的断点续传
4. **缓存机制**：缓存已下载的视频，避免重复下载
5. **视频压缩**：保存前压缩视频，节省存储空间



