# 解决 "url not in domain list" 错误

## 问题

请求后端接口时出现错误：
```
errMsg: "request:fail url not in domain list"
```

## 原因

微信小程序要求所有网络请求的域名必须在微信公众平台后台配置的服务器域名白名单中。开发环境使用 `localhost` 或未配置的域名会触发此错误。

## 解决方案

### 方案一：开发环境 - 不校验合法域名（推荐用于开发调试）

**在微信开发者工具中设置：**

1. 打开微信开发者工具
2. 点击右上角的 **`详情`** 按钮
3. 在 **`本地设置`** 标签页中
4. 勾选 **`不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书`**
5. 关闭并重新打开项目（或重新编译）

**设置位置：**
```
微信开发者工具 → 详情 → 本地设置 → 不校验合法域名
```

✅ **优点**：立即生效，无需配置  
⚠️ **注意**：仅用于开发环境，正式发布前需要配置真实域名

### 方案二：配置服务器域名（用于生产环境）

如果需要在真机上测试或正式发布，需要在微信公众平台配置服务器域名：

1. **登录微信公众平台**
   - 访问：https://mp.weixin.qq.com
   - 使用小程序管理员账号登录

2. **配置服务器域名**
   - 进入：`开发` → `开发管理` → `开发设置` → `服务器域名`
   - 在 **`request合法域名`** 中添加你的后端服务器域名
   - 例如：`https://api.yourdomain.com`
   - 点击 `保存`

3. **注意事项**
   - 域名必须使用 HTTPS（生产环境）
   - 域名必须已备案（国内服务器）
   - 每月最多可修改 5 次

### 方案三：使用内网穿透（用于真机调试）

如果需要真机调试但不想配置域名，可以使用内网穿透工具：

1. **使用 ngrok**
   ```bash
   ngrok http 8080
   ```
   会生成一个公网地址，如：`https://xxxxx.ngrok.io`

2. **修改后端地址**
   - 在 `common/utils/request.js` 中修改 `baseUrl`
   - 使用 ngrok 生成的地址

3. **配置到微信小程序**
   - 在微信公众平台添加该域名到服务器域名白名单

**其他内网穿透工具：**
- ngrok：https://ngrok.com/
- 花生壳：https://hsk.oray.com/
- 内网穿透：https://natapp.cn/

## 当前配置检查

### 检查后端地址

当前配置的后端地址：
- `common/utils/request.js`: `http://localhost:8080`
- `App.vue`: `http://localhost:8080`
- `pages/index/index.vue`: `http://localhost:8080`

### 开发环境快速修复

**立即解决（推荐）：**

1. 打开微信开发者工具
2. 点击右上角 **`详情`**
3. 勾选 **`不校验合法域名`**
4. 重新编译运行

## 生产环境配置

### 步骤 1：准备 HTTPS 域名

确保你的后端服务：
- ✅ 使用 HTTPS（必须）
- ✅ 域名已备案（国内服务器）
- ✅ 可以正常访问

### 步骤 2：修改代码中的后端地址

修改以下文件中的后端地址：

**`common/utils/request.js`**
```javascript
const baseUrl = 'https://api.yourdomain.com'; // 替换为实际域名
```

**`App.vue`**
```javascript
url: 'https://api.yourdomain.com/auth/wx-login'
```

**`pages/index/index.vue`**
```javascript
url: 'https://api.yourdomain.com/auth/wx-login'
```

**`common/utils/auth.js`**
```javascript
url: 'https://api.yourdomain.com/auth/wx-login'
```

### 步骤 3：在微信公众平台配置

1. 登录：https://mp.weixin.qq.com
2. 进入：`开发` → `开发管理` → `开发设置`
3. 在 **`服务器域名`** → **`request合法域名`** 中添加：
   ```
   https://api.yourdomain.com
   ```
4. 点击 `保存`

## 验证

配置完成后：

1. **开发环境**：勾选"不校验合法域名"后，应该可以正常请求
2. **生产环境**：在真机上测试，应该可以正常请求

## 常见问题

### Q: 为什么必须使用 HTTPS？

A: 微信小程序要求生产环境必须使用 HTTPS，这是安全要求。

### Q: 可以使用 IP 地址吗？

A: 不可以，微信小程序只支持域名，不支持 IP 地址。

### Q: 本地开发可以使用 localhost 吗？

A: 可以，但需要在微信开发者工具中勾选"不校验合法域名"。

### Q: 修改域名后多久生效？

A: 立即生效，但需要重新编译小程序。

## 快速检查清单

- [ ] 微信开发者工具中已勾选"不校验合法域名"（开发环境）
- [ ] 后端服务已启动并运行在 8080 端口
- [ ] 后端地址配置正确（`common/utils/request.js`）
- [ ] 已重新编译项目
- [ ] 网络请求可以正常发送

## 立即解决

**最快的方法：**

1. 打开微信开发者工具
2. 点击右上角 **`详情`** 按钮
3. 勾选 **`不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书`**
4. 关闭设置窗口
5. 重新编译运行

这样应该可以立即解决域名白名单错误！




